# 新功能说明

## 已实现的功能

### 1. .ics 日历文件导出
- 生成旅行计划后，可以导出为 `.ics` 格式的日历文件
- 支持导入到 Google Calendar、Outlook、Apple Calendar 等日历应用
- 可以设置行程开始日期
- 每天的活动会自动创建为日历事件

**使用方法：**
1. 生成旅行计划后，点击 "Export to Calendar (.ics)" 按钮
2. 选择行程开始日期（默认为明天）
3. 下载 `.ics` 文件
4. 双击文件或导入到您的日历应用

### 2. 本地 LLM 支持（Ollama）
- 支持使用本地运行的 Ollama 来生成旅行计划
- 保护数据隐私，所有数据在本地处理
- 无需 API 密钥，完全免费

**配置方法：**
1. 安装 Ollama：访问 https://ollama.ai 下载并安装
2. 下载模型（例如 llama3.2）：
   ```bash
   ollama pull llama3.2
   ```
3. 在 `.env` 文件中配置（可选）：
   ```
   LLM_MODE=local
   OLLAMA_BASE_URL=http://localhost:11434
   OLLAMA_MODEL=llama3.2
   ```
4. 启动 Ollama 服务（通常安装后会自动启动）
5. 在前端选择 "Local (Data Privacy)" 模式

### 3. LLM 模式切换
- **Cloud (High Performance)**: 使用 DeepSeek API，响应速度快，质量高
- **Local (Data Privacy)**: 使用本地 Ollama，数据隐私保护，完全免费

**使用方法：**
- 在生成计划表单中，选择 "LLM Mode" 下拉框
- 选择 "Cloud" 或 "Local" 模式
- 然后生成计划

## 环境变量配置

在 `.env` 文件中可以配置以下选项：

```env
# LLM 模式：cloud 或 local（默认：cloud）
LLM_MODE=cloud

# DeepSeek API（云端模式必需）
DEEPSEEK_API_KEY=your_api_key_here

# Ollama 配置（本地模式）
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama3.2

# Google 搜索（可选）
GOOGLE_API_KEY=your_google_api_key
GOOGLE_SEARCH_ENGINE_ID=your_search_engine_id
```

## 安装新依赖

运行以下命令安装新的依赖：

```bash
pip install -r requirements.txt
```

新增的依赖：
- `ics>=0.8` - 用于生成 .ics 日历文件

## 注意事项

1. **本地 LLM 模式**：
   - 需要先安装并运行 Ollama
   - 需要下载相应的模型（如 llama3.2）
   - 本地模式生成速度可能较慢，取决于您的硬件配置
   - 确保 Ollama 服务正在运行（默认端口 11434）

2. **.ics 导出**：
   - 导出的日历文件包含每天的行程安排
   - 如果计划格式不规范，可能无法正确解析所有日期
   - 建议在生成计划后检查导出的日历文件

3. **模式切换**：
   - 可以在每次生成计划时选择不同的模式
   - 云端模式需要有效的 API 密钥
   - 本地模式需要 Ollama 运行中

## 故障排除

### 本地 LLM 无法连接
- 检查 Ollama 是否正在运行：`ollama list`
- 检查端口是否正确（默认 11434）
- 检查防火墙设置
- 查看服务器日志获取详细错误信息

### .ics 文件无法导入
- 检查文件格式是否正确
- 尝试用文本编辑器打开 .ics 文件查看内容
- 确保日历应用支持 .ics 格式

### 模式切换不生效
- 检查 `.env` 文件中的 `LLM_MODE` 设置
- 前端选择会覆盖 `.env` 中的默认设置
- 查看服务器日志确认使用的模式

