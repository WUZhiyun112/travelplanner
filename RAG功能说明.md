# RAG功能使用说明

## 功能概述

RAG (Retrieval-Augmented Generation) 功能允许用户上传小红书攻略，系统会自动处理并存储到知识库中。在生成旅游计划时，系统会从知识库中检索相关攻略信息，使生成的计划更加精准和个性化。

## 实现思路

### 1. 文本处理流程
- 用户粘贴小红书攻略文本
- 系统清理和规范化文本
- 自动提取关键信息（目的地、天数等）
- 将文本分割成适合向量化的块（chunks）

### 2. PDF生成
- 使用ReportLab库将处理后的文本生成PDF文件
- PDF包含格式化的攻略内容
- 用户可下载PDF作为备份

### 3. 向量化存储
- 使用Sentence Transformers生成文本嵌入向量
- 使用ChromaDB作为向量数据库存储
- 每个文本块都包含元数据（标题、目的地、天数等）

### 4. RAG检索
- 在生成旅游计划时，根据目的地和天数检索相关攻略
- 使用语义相似度搜索找到最相关的攻略片段
- 将检索到的内容作为上下文注入到LLM提示词中

## 安装依赖

首先安装RAG相关的Python包：

```bash
pip install -r requirements.txt
```

主要依赖包：
- `chromadb>=0.4.0` - 向量数据库
- `sentence-transformers>=2.2.0` - 文本嵌入模型
- `reportlab>=4.0.0` - PDF生成
- `langchain>=0.1.0` - 可选，用于更高级的文本处理

## 使用方法

### 步骤1：上传攻略

1. 在网页中找到"📚 上传小红书攻略 (RAG功能)"部分
2. 输入攻略标题（可选）
3. 粘贴小红书攻略的完整文本内容
4. 点击"处理攻略并生成PDF"按钮

系统会：
- 处理文本并生成PDF文件（自动下载）
- 将内容存储到向量数据库
- 显示处理成功消息

### 步骤2：生成旅游计划

1. 填写旅游信息（天数、目的地等）
2. 点击"生成计划"按钮
3. 系统会自动从知识库中检索相关攻略
4. 基于检索到的攻略信息生成更精准的旅游计划

## 技术细节

### 文本分块策略
- 默认块大小：500字符
- 块重叠：50字符（保持上下文连续性）
- 优先按段落分割，长段落进一步分割

### 向量模型
- 默认使用：`paraphrase-multilingual-MiniLM-L12-v2`
- 支持中文和英文
- 如果加载失败，会回退到 `all-MiniLM-L6-v2`

### 检索参数
- 默认检索数量：5条
- 支持按目的地过滤
- 使用余弦相似度计算相关性

### 数据存储
- 向量数据库存储在 `chroma_db/` 目录
- PDF文件可存储在 `pdf_storage/` 目录（可选）
- 数据持久化，重启后仍可使用

## API端点

### POST /api/process-guide
处理小红书攻略并生成PDF

**请求体：**
```json
{
  "guide_text": "攻略文本内容",
  "title": "攻略标题（可选）"
}
```

**响应：**
- 成功：返回PDF文件（下载）
- 失败：返回JSON错误信息

### POST /api/generate-plan
生成旅游计划（已集成RAG检索）

**请求体：**
```json
{
  "days": "3",
  "destination": "东京",
  "budget": "5000 CNY",
  "preferences": "美食、购物",
  "llm_mode": "cloud",
  "use_rag": true  // 是否使用RAG检索
}
```

## 注意事项

1. **首次使用**：系统需要下载嵌入模型，可能需要一些时间
2. **内存要求**：向量数据库和嵌入模型需要一定内存
3. **依赖安装**：如果RAG功能不可用，检查是否安装了所有依赖包
4. **中文支持**：确保使用支持中文的嵌入模型

## 故障排除

### RAG功能不可用
- 检查是否安装了所有依赖：`pip install -r requirements.txt`
- 查看日志文件了解详细错误信息
- 确保有足够的磁盘空间存储向量数据库

### PDF生成失败
- 检查文本内容是否为空
- 查看服务器日志了解详细错误

### 检索结果为空
- 确保已经上传了相关攻略
- 检查目的地名称是否匹配
- 尝试使用更通用的搜索词

## 未来改进方向

1. 支持批量上传攻略
2. 添加攻略管理界面（查看、删除已上传的攻略）
3. 支持更多文档格式（Word、Markdown等）
4. 优化检索算法，提高相关性
5. 添加用户反馈机制，改进检索质量

